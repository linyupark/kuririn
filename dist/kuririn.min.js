var Kuririn=function(){"use strict";var n=function(){return(n=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};var o=["error","userinfo","performance"],s={qs:function(t){void 0===t&&(t={});var e=n({},t);return Object.keys(e).map(function(t){return~Object.prototype.toString.call(e[t]).search(/Array|Object/)&&(e[t]=JSON.stringify(e[t])),encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},resetHistory:function(r){var n=history[r];return function(){var t=n.apply(this,arguments),e=new Event(r);return e.arguments=arguments,window.dispatchEvent(e),t}}};function t(t,e){var r=this;this.debug=!1,this.modules=["error","userinfo"],this.userinfo={url:"",history:[],title:"",agent:navigator.userAgent,platform:navigator.platform},this.reportUrl="http://api-s1.dynv6.net:10010/kuririn/test",this.injectAPI=function(){return{}},this.matchAPI={},this.appId=t.appId,this.appName=t.appName,t.debug&&(this.debug=t.debug),t.injectAPI&&(this.injectAPI=t.injectAPI),t.matchAPI&&(this.matchAPI=t.matchAPI),t.modules&&(this.modules=t.modules.filter(function(t){return~o.indexOf(t)})),t.reportUrl&&(this.reportUrl=t.reportUrl),e&&(this.userinfo=n(n({},this.userinfo),e)),this.mod_logicTracker(),this.modules.map(function(t){r["mod_"+t].apply(r,[])})}return t.prototype.func_log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&console.log.apply(console,t)},t.prototype.func_onError=function(t){var r,e=this;return r=t,new Promise(function(e){setTimeout(function(){var t={filename:r.filename,lineno:r.lineno||0,colno:r.colno||0,message:r.message||"无法获取详细错误信息"};r.error&&r.error.stack&&(t.message=r.error.stack.toString()),e({type:"ERROR_JS",error:t})},10)}).then(function(t){return e.func_report(t)}),!1},t.prototype.func_onPopstate=function(t){this.userinfo=function(t,e){return""!==e.url&&("pushState"===t?e.history.unshift(e.url):"replaceState"===t?e.history[0]=e.url:this.userinfo.history[0]===document.URL?e.history=e.history.slice(1,5):e.history.unshift(e.url),e.history=e.history.slice(0,5)),e.url=document.URL,e.title=document.title,e}(t.type,this.userinfo)},t.prototype.func_report=function(t){var e=n({appId:this.appId,appName:this.appName,userinfo:this.userinfo,injectData:this.injectAPI()},t);this.func_log("kuririn report:",e);var r=new XMLHttpRequest;r.open("POST",this.reportUrl,!0),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(e))},t.prototype.func_injectXHR=function(){var t="",e="",r=window.XMLHttpRequest.prototype.open,n=window.XMLHttpRequest.prototype.send,o=s.qs(this.injectAPI()),i=this;window.XMLHttpRequest.prototype.open=function(){t=arguments[1],"get"===(e=arguments[0]).toLowerCase()&&t!==i.reportUrl&&o&&(t+=-1!==t.indexOf("?")?"&":"?",arguments[1]=t+=o),r.apply(this,[].slice.call(arguments))},window.XMLHttpRequest.prototype.send=function(){var o={url:t,method:e,status:"",res:"",data:arguments[0]||{}};this.addEventListener("readystatechange",function(){if(4===this.readyState)if(o.res=this.response,o.status=this.status,400<=this.status&&o.url!==i.reportUrl)i.func_report({type:"ERROR_XHR_STATUS",error:o});else try{var n=JSON.parse(o.res);Object.keys(i.matchAPI).map(function(t){var e=i.matchAPI[t].map(function(t){return String(t)}),r=String(n[t]);n[t]&&-1!==e.indexOf(r)&&i.func_report({type:"MATCH_XHR_"+t.toUpperCase()+"_"+r.toUpperCase(),error:o})})}catch(t){o.res="**非JSON数据**: "+o.res,i.func_report({type:"ERROR_XHR_RESPONSE_PARSE",error:o})}}),this.addEventListener("error",function(){o.url!==i.reportUrl&&i.func_report({error:o})}),n.apply(this,[].slice.call(arguments))}},t.prototype.mod_logicTracker=function(){this.func_log("kuririn: mod_logicTracker ----- on"),this.func_injectXHR()},t.prototype.mod_error=function(){window.addEventListener("error",this.func_onError.bind(this),!1)},t.prototype.mod_userinfo=function(){this.func_log("kuririn: mod_userinfo ----- on"),this.userinfo.agent=navigator.userAgent,0!="onpopstate"in window&&(window.history.pushState=s.resetHistory("pushState"),window.history.replaceState=s.resetHistory("replaceState"),window.addEventListener("pushState",this.func_onPopstate.bind(this),!1),window.addEventListener("replaceState",this.func_onPopstate.bind(this),!1),window.addEventListener("popstate",this.func_onPopstate.bind(this),!1))},t.prototype.mod_performance=function(){this.func_log("kuririn: mod_performance ----- on"),this.func_report({type:"PERFORMANCE",performance:function(){if(0=="performance"in window)return{};var t=performance.timing,e=t.navigationStart;return{dnsTime:t.domainLookupEnd-t.domainLookupStart,tcpTime:t.connectEnd-t.connectStart,firstPaintTime:t.responseStart-e,domRenderTime:t.domContentLoadedEventEnd-e,loadTime:t.loadEventEnd-e}}()})},t}();

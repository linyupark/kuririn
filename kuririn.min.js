var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},Kuririn=function(){var n=["error","userinfo","performance"],s=function(t){void 0===t&&(t={});var e=__assign({},t);return Object.keys(e).map(function(t){return~Object.prototype.toString.call(e[t]).search(/Array|Object/)&&(e[t]=JSON.stringify(e[t])),encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},t=function(r){var n=history[r];return function(){var t=n.apply(this,arguments),e=new Event(r);return e.arguments=arguments,window.dispatchEvent(e),t}};function e(t,e){var r=this;this.debug=!1,this.modules=["error","userinfo"],this.userinfo={url:"",history:[],title:"",agent:navigator.userAgent,platform:navigator.platform},this.reportUrl="http://api-s1.dynv6.net:10010/kuririn/test",this.injectAPI=function(){return{}},this.matchAPI={},this.appId=t.appId,this.appName=t.appName,t.debug&&(this.debug=t.debug),t.injectAPI&&(this.injectAPI=t.injectAPI),t.matchAPI&&(this.matchAPI=t.matchAPI),t.modules&&(this.modules=t.modules.filter(function(t){return~n.indexOf(t)})),t.reportUrl&&(this.reportUrl=t.reportUrl),e&&(this.userinfo=__assign(__assign({},this.userinfo),e)),this.mod_logicTracker(),this.modules.map(function(t){r["mod_"+t].apply(r,[])})}return window.history.pushState=t("pushState"),window.history.replaceState=t("replaceState"),e.prototype.func_log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&console.log.apply(console,t)},e.prototype.func_onError=function(e){var r=this;return setTimeout(function(){var t={type:"js",filename:e.filename,lineno:e.lineno||0,colno:e.colno||0,message:e.message||"无法获取详细错误信息"};e.error&&e.error.stack&&(t.message=e.error.stack.toString()),r.func_report({error:t})},0),!1},e.prototype.func_getUserinfo=function(t){""!==this.userinfo.url&&("pushState"===t?this.userinfo.history.unshift(this.userinfo.url):"replaceState"===t?this.userinfo.history[0]=this.userinfo.url:this.userinfo.history[0]===document.URL?this.userinfo.history=this.userinfo.history.slice(1,5):this.userinfo.history.unshift(this.userinfo.url),this.userinfo.history=this.userinfo.history.slice(0,5)),this.userinfo.url=document.URL,this.userinfo.title=document.title,this.func_log("kuririn update userinfo:",this.userinfo)},e.prototype.func_onPopstate=function(t){this.func_getUserinfo(t.type)},e.prototype.func_report=function(t){var e=__assign({appId:this.appId,appName:this.appName,userinfo:this.userinfo,injectData:this.injectAPI()},t);this.func_log("kuririn report:",e);var r=new XMLHttpRequest;r.open("POST",this.reportUrl,!0),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(e))},e.prototype.func_injectXHR=function(){var t="",e="",r=window.XMLHttpRequest.prototype.open,i=window.XMLHttpRequest.prototype.send,n=s(this.injectAPI()),o=this;window.XMLHttpRequest.prototype.open=function(){t=arguments[1],"get"===(e=arguments[0]).toLowerCase()&&t!==o.reportUrl&&n&&(t+=-1!==t.indexOf("?")?"&":"?",arguments[1]=t+=n),r.apply(this,[].slice.call(arguments))},window.XMLHttpRequest.prototype.send=function(){var n={type:"xhr",url:t,method:e,status:"",res:"",data:arguments[0]||{}};this.addEventListener("readystatechange",function(){if(4===this.readyState)if(n.res=this.response,n.status=this.status,400<=this.status&&n.url!==o.reportUrl)o.func_report({error:n});else try{var r=JSON.parse(n.res);Object.keys(o.matchAPI).map(function(t){var e=o.matchAPI[t].map(function(t){return String(t)});r[t]&&-1!==e.indexOf(String(r[t]))&&o.func_report({error:n})})}catch(t){n.res="**非JSON数据**: "+n.res,o.func_report({error:n})}}),this.addEventListener("error",function(){n.url!==o.reportUrl&&o.func_report({error:n})}),i.apply(this,[].slice.call(arguments))}},e.prototype.mod_logicTracker=function(){this.func_log("kuririn: mod_logicTracker ----- on"),this.func_injectXHR()},e.prototype.mod_error=function(){window.addEventListener("error",this.func_onError.bind(this),!1)},e.prototype.mod_userinfo=function(){this.func_log("kuririn: mod_userinfo ----- on"),"onpopstate"in window&&(window.addEventListener("pushState",this.func_onPopstate.bind(this),!1),window.addEventListener("replaceState",this.func_onPopstate.bind(this),!1),window.addEventListener("popstate",this.func_onPopstate.bind(this),!1)),this.userinfo.agent=navigator.userAgent},e.prototype.mod_performance=function(){this.func_log("kuririn: mod_performance ----- on");var t=performance.timing,e=t.navigationStart,r=t.domainLookupEnd-t.domainLookupStart,n=t.connectEnd-t.connectStart,i=t.responseStart-e,o=t.domContentLoadedEventEnd-e,s=t.loadEventEnd-e;this.func_report({performance:{dnsTime:r,tcpTime:n,firstPaintTime:i,domRenderTime:o,loadTime:s}})},e}();